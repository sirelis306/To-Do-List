<div class="detail-modal-backdrop" (click)="onCerrar()"></div>
<div class="detail-modal-content">
  <div class="modal-header-buttons">
    
    @if (!modoEdicion) {
      <button class="edit-btn" (click)="onActivarEdicion()" title="Editar Tarea">
        <i class="fa-solid fa-pen"></i>
      </button>
    }
    
    @if (modoEdicion) {
      <button class="save-btn" (click)="onGuardar()" title="Guardar y Cerrar">
        <i class="fa-solid fa-check"></i>
      </button>
    }
    
    <button class="close-btn" (click)="onCerrar()" title="Cerrar sin guardar">×</button>
  </div>
  
  <div class="task-title-section">
    @if (!modoEdicion) {
      <h2>{{ tarea.titulo }}</h2>
      } @else {
        <input type="text" [(ngModel)]="tempTitulo" (keyup.enter)="onGuardar()" autofocus/>
      }
  </div>

  <div class="task-controls">
    <div class="control-item">

      <span>Categoría:</span>
        @if (modoEdicion) {
          <app-custom-dropdown label="Ninguna" [options]="categoriasParaDropdown" [selectedValue]="tempCategoria || ''" (valueChange)="onCategoriaChange($event)"></app-custom-dropdown>
        } 
        
        @else {
          <span class="detail-text">{{ tarea.categoria | titlecase }}</span>
        }
    </div>

    <div class="control-item">
      <span>Importancia:</span>
        @if (modoEdicion) {
          <app-custom-dropdown label="Normal" [options]="opcionesImportancia" [selectedValue]="tempImportancia || ''" (valueChange)="onImportanciaChange($event)"></app-custom-dropdown>
        } 
        
        @else {
          <span class="detail-text">{{ tarea.importancia | titlecase }}</span>
        }
    </div>

    <div class="control-item">
      <span>Estado:</span>

        @if (modoEdicion) {
          <app-custom-dropdown label="Seleccionar" [options]="opcionesEstado" [selectedValue]="estadoLabels[tempEstado]" (valueChange)="onEstadoChange($event)"></app-custom-dropdown>
        } 
        
        @else {
          <span class="detail-text">{{ estadoLabels[tarea.estado] }}</span>        }
    </div>
  </div>

  <div class="subtasks-section">
   <h3>Sub-tareas ({{ subtareasCompletadas }}/{{ totalSubtareas }})</h3>

    @if (modoEdicion) {
      <div class="add-subtask-form">
        <input type="text" placeholder="Añadir sub-tarea..." [(ngModel)]="nuevoSubtareaDescripcion" (keyup.enter)="agregarSubtarea()"/>
        <button class="add-subtask-btn" (click)="agregarSubtarea()">
          <i class="fa-solid fa-plus"></i>
        </button>
      </div>
    }

    <div class="subtask-list">
      @for (subtarea of (modoEdicion ? tempSubtareas : tarea.subtareas); track subtarea.id) {
        <div class="subtask-item">
          
          <input type="checkbox" 
                [checked]="subtarea.completada" 
                (change)="marcarSubtarea(subtarea)" 
                [id]="'subtask-' + subtarea.id"
               [disabled]="!modoEdicion"/> <label [for]="'subtask-' + subtarea.id" [class.completed]="subtarea.completada">{{ subtarea.descripcion }}</label>
          
          @if (modoEdicion) {
            <button class="delete-subtask-btn" (click)="eliminarSubtarea(subtarea.id)">
              <i class="fa-solid fa-trash"></i>
            </button>
          }
        </div>
      } @empty {
        <p class="no-subtasks">No hay subtareas para esta tarea.</p>
      }
    </div>
  </div>
</div>
